name: Weirdhost Auto Renew

on:
  schedule:
    - cron: '0 17 * * *'  # æ¯å¤© UTC 1:00 (åŒ—äº¬æ—¶é—´ 9:00) è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  login-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®30åˆ†é’Ÿè¶…æ—¶ï¼Œé¿å…GitHub Actionsé»˜è®¤6å°æ—¶å¤ªé•¿
    
    # æˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      contents: write
      actions: write  # å¢åŠ æ­¤é¡¹ä»¥åŒ¹é… auto-renew çš„æƒé™é…ç½®
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install playwright
        playwright install chromium
          
    - name: Set up WARP
      uses: fscarmen/warp-on-actions@v1.4
      with:
        stack: dual        # Optional. Support [ ipv4, ipv6, dual ]. Default is dual.
        mode: wireguard    # Optional. Support [ wireguard, client ]. Default is wireguard.   
      
    - name: Run auto renewal
      env:
        REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
        WEIRDHOST_EMAIL: ${{ secrets.WEIRDHOST_EMAIL }}
        WEIRDHOST_PASSWORD: ${{ secrets.WEIRDHOST_PASSWORD }}
        WEIRDHOST_SERVER_URLS: ${{ secrets.WEIRDHOST_SERVER_URLS }}
      run: python main.py
    
    - name: ğŸ“ æäº¤README.mdåˆ°ä»“åº“
      if: always()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°ç»­æœŸçŠ¶æ€æŠ¥å‘Š [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')]"
        git push origin HEAD:main

    - name: ğŸ“± å‘é€Telegramé€šçŸ¥
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # é’ˆå¯¹ main-w.py ç”Ÿæˆçš„è¡¨æ ¼æ ¼å¼è¿›è¡Œæå–
        if [ -f "README.md" ]; then
          # æå–è¡¨æ ¼ä¸­ç¬¬ä¸€å°æœåŠ¡å™¨çš„çŠ¶æ€ä½œä¸ºä»£è¡¨ï¼ˆæˆ–æ±‡æ€»ä¿¡æ¯ï¼‰
          RENEWAL_STATUS=$(grep "|" README.md | grep -v "ID" | grep -v "\-\-\-" | head -n 1 | cut -d'|' -f 3 | xargs || echo "æŸ¥çœ‹æ—¥å¿—")
          START_STATUS=$(grep "|" README.md | grep -v "ID" | grep -v "\-\-\-" | head -n 1 | cut -d'|' -f 4 | xargs || echo "æŸ¥çœ‹æ—¥å¿—")
          RUN_TIME=$(grep "æœ€åè¿è¡Œæ—¶é—´" README.md | cut -d'`' -f 2 || date)
        else
          RENEWAL_STATUS="æœªçŸ¥"
          START_STATUS="æœªçŸ¥"
          RUN_TIME="æ— è®°å½•"
        fi
        
        MESSAGE="ğŸ¢ Weirdhost è‡ªåŠ¨åŒ–æŠ¥å‘Š
        ğŸ“… æ—¶é—´ï¼š${RUN_TIME}
        
        ğŸ“Š ç»­æœŸçŠ¶æ€ï¼š${RENEWAL_STATUS}
        ğŸš€ å¯åŠ¨çŠ¶æ€ï¼š${START_STATUS}
        
        ğŸ”— [æŸ¥çœ‹ GitHub Actions è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="Markdown"
